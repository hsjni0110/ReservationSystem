-- =============================================
-- ğŸšŒ ë²„ìŠ¤ ì˜ˆì•½ ì‹œìŠ¤í…œ ë™ì  ë”ë¯¸ ë°ì´í„° ìƒì„± SQL
-- ìƒì„±ì¼ì‹œ: {{ generation_time }}
-- ë°ì´í„° ê¸°ê°„: {{ start_date }} ~ {{ end_date }}
-- ì´ ë…¸ì„  ìˆ˜: {{ total_routes }}ê°œ
-- ì´ ì‹œê°„ëŒ€ ìŠ¬ë¡¯ ìˆ˜: {{ total_time_slots }}ê°œ
-- =============================================

-- ë¬¸ìì…‹ ì„¤ì •
SET NAMES utf8mb4;
SET CHARACTER SET utf8mb4;

-- ì™¸ë˜í‚¤ ì²´í¬ ë¹„í™œì„±í™”
SET FOREIGN_KEY_CHECKS = 0;

-- ê¸°ì¡´ ë°ì´í„° ì´ˆê¸°í™” (ì™¸ë˜í‚¤ ìˆœì„œ ê³ ë ¤)
DELETE FROM reservation.scheduled_seat;
DELETE FROM reservation.route_schedule_scheduled_seats;
DELETE FROM reservation.route_schedule;
DELETE FROM reservation.route_route_time_slots;
DELETE FROM reservation.route_time_slot;
DELETE FROM reservation.route;
DELETE FROM reservation.bus;

-- ì™¸ë˜í‚¤ ì²´í¬ ì¬í™œì„±í™”
SET FOREIGN_KEY_CHECKS = 1;

-- AUTO_INCREMENT ì´ˆê¸°í™”
ALTER TABLE reservation.bus AUTO_INCREMENT = 1;
ALTER TABLE reservation.route AUTO_INCREMENT = 1;
ALTER TABLE reservation.route_time_slot AUTO_INCREMENT = 1;
ALTER TABLE reservation.route_schedule AUTO_INCREMENT = 1;
ALTER TABLE reservation.scheduled_seat AUTO_INCREMENT = 1;

-- =============================================
-- 1. ğŸš ë²„ìŠ¤ ë°ì´í„° ì‚½ì… ({{ bus_count }}ëŒ€)
-- =============================================

INSERT INTO reservation.bus (created_at, updated_at, bus_name, bus_number, capacity) VALUES
{%- for bus in buses %}
('{{ bus.created_at }}', '{{ bus.updated_at }}', '{{ bus.bus_name }}', '{{ bus.bus_number }}', {{ bus.capacity }})
{%- if not loop.last %},{% endif %}
{%- endfor %};

-- =============================================
-- 2. ğŸ›£ï¸ ë…¸ì„  ë°ì´í„° ì‚½ì… ({{ total_routes }}ê°œ)
-- =============================================

INSERT INTO reservation.route (departure, arrival, schedule_date) VALUES
{%- for route in routes %}
('{{ route.departure }}', '{{ route.arrival }}', '{{ route.schedule_date }}')
{%- if not loop.last %},{% endif %}
{%- endfor %};

-- =============================================
-- 3. â° ì‹œê°„ëŒ€ ìŠ¬ë¡¯ ìƒì„± ({{ total_time_slots }}ê°œ)
-- =============================================

-- ë…¸ì„ ë³„ ì‹œê°„ëŒ€ ìŠ¬ë¡¯ ìƒì„±
INSERT INTO reservation.route_time_slot (time_slot, route_id) VALUES
{%- for time_slot in time_slots %}
('{{ time_slot.time }}', {{ time_slot.route_id }})
{%- if not loop.last %},{% endif %}
{%- endfor %};

-- route_route_time_slots ê´€ê³„ í…Œì´ë¸” ë°ì´í„° ì‚½ì…
INSERT INTO reservation.route_route_time_slots (route_route_id, route_time_slots_route_time_slot_id)
SELECT r.route_id, rts.route_time_slot_id
FROM reservation.route r
JOIN reservation.route_time_slot rts ON r.route_id = rts.route_id;

-- =============================================
-- 4. ğŸ“… ë…¸ì„  ìŠ¤ì¼€ì¤„ ìƒì„± (ë²„ìŠ¤ í• ë‹¹)
-- =============================================

-- UNIQUE ì œì•½ì¡°ê±´ì„ ê³ ë ¤í•˜ì—¬ ë²„ìŠ¤ ìˆ˜ë§Œí¼ë§Œ ìŠ¤ì¼€ì¤„ ìƒì„±
-- ê° ë²„ìŠ¤ëŠ” í•˜ë‚˜ì˜ ìŠ¤ì¼€ì¤„ì—ë§Œ í• ë‹¹ (1:1 ë§¤í•‘)
INSERT INTO reservation.route_schedule (created_at, updated_at, available_seats, sale_status, bus, route_time_slot)
SELECT 
    NOW(),
    NOW(),
    b.capacity,
    'ON_SALE',
    b.bus_id,
    rts.route_time_slot_id
FROM (
    SELECT 
        bus_id, 
        capacity, 
        ROW_NUMBER() OVER (ORDER BY bus_id) as rn
    FROM reservation.bus
) b
JOIN (
    SELECT 
        route_time_slot_id,
        ROW_NUMBER() OVER (ORDER BY route_time_slot_id) as rn
    FROM reservation.route_time_slot
    WHERE route_time_slot_id <= {{ bus_count }}
) rts ON b.rn = rts.rn;

-- =============================================
-- 5. ğŸ’º ì¢Œì„ ë°ì´í„° ìƒì„±
-- =============================================

INSERT INTO reservation.scheduled_seat (created_at, updated_at, is_reserved, seat_id, seat_price, route_schedule_route_schedule_id)
SELECT 
    rs.created_at,
    rs.updated_at,
    CASE 
        WHEN RAND() > 0.{{ reservation_rate }} THEN 1  -- {{ 100 - reservation_rate }}% í™•ë¥ ë¡œ ì˜ˆì•½ë¨
        ELSE 0
    END,
    seat_num.seat_id,
    CASE 
        WHEN b.bus_name = 'í”„ë¦¬ë¯¸ì—„ë²„ìŠ¤' THEN 
            CASE WHEN r.schedule_date >= '2025-07-01' THEN {{ prices.premium.high }}.00 ELSE {{ prices.premium.low }}.00 END
        WHEN b.bus_name = 'ìš°ë“±ê³ ì†ë²„ìŠ¤' THEN 
            CASE WHEN r.schedule_date >= '2025-07-01' THEN {{ prices.deluxe.high }}.00 ELSE {{ prices.deluxe.low }}.00 END
        ELSE 
            CASE WHEN r.schedule_date >= '2025-07-01' THEN {{ prices.standard.high }}.00 ELSE {{ prices.standard.low }}.00 END
    END,
    rs.route_schedule_id
FROM reservation.route_schedule rs
JOIN reservation.bus b ON rs.bus = b.bus_id
JOIN reservation.route_time_slot rts ON rs.route_time_slot = rts.route_time_slot_id
JOIN reservation.route r ON rts.route_id = r.route_id
CROSS JOIN (
    {%- for i in range(1, max_capacity + 1) %}
    SELECT {{ i }} as seat_id
    {%- if not loop.last %} UNION ALL{% endif %}
    {%- endfor %}
) seat_num
WHERE seat_num.seat_id <= b.capacity;

-- route_schedule_scheduled_seats ê´€ê³„ í…Œì´ë¸” ë°ì´í„° ì‚½ì…
INSERT INTO reservation.route_schedule_scheduled_seats (route_schedule_route_schedule_id, scheduled_seats_scheduled_seat_id)
SELECT ss.route_schedule_route_schedule_id, ss.scheduled_seat_id
FROM reservation.scheduled_seat ss
WHERE ss.route_schedule_route_schedule_id IS NOT NULL;

-- =============================================
-- 6. ğŸ“Š ì‹¤ì‹œê°„ ì˜ˆì•½ í˜„í™© ì—…ë°ì´íŠ¸
-- =============================================

-- ìŠ¤ì¼€ì¤„ì˜ available_seatsë¥¼ ì‹¤ì œ ì˜ˆì•½ í˜„í™©ì— ë§ê²Œ ì—…ë°ì´íŠ¸
UPDATE reservation.route_schedule rs
JOIN reservation.bus b ON rs.bus = b.bus_id
SET rs.available_seats = b.capacity - COALESCE((
    SELECT COUNT(*) 
    FROM reservation.scheduled_seat ss 
    WHERE ss.route_schedule_route_schedule_id = rs.route_schedule_id 
    AND ss.is_reserved = 1
), 0);

-- =============================================
-- 7. ğŸ“ˆ ë°ì´í„° ìƒì„± ê²°ê³¼ í™•ì¸
-- =============================================

SELECT '=== ğŸšŒ ë™ì  ë”ë¯¸ ë°ì´í„° ìƒì„± ì™„ë£Œ! ===' as result;

SELECT 'Bus Count' as entity, COUNT(*) as count FROM reservation.bus
UNION ALL
SELECT 'Total Route Count', COUNT(*) FROM reservation.route
UNION ALL  
SELECT 'July 2025 Route Count', COUNT(*) FROM reservation.route WHERE schedule_date >= '2025-07-01' AND schedule_date < '2025-08-01'
UNION ALL
SELECT 'Route Time Slot Count', COUNT(*) FROM reservation.route_time_slot
UNION ALL
SELECT 'Route Schedule Count', COUNT(*) FROM reservation.route_schedule
UNION ALL
SELECT 'Total Scheduled Seat Count', COUNT(*) FROM reservation.scheduled_seat
UNION ALL
SELECT 'Reserved Seat Count', COUNT(*) FROM reservation.scheduled_seat WHERE is_reserved = 1
UNION ALL
SELECT 'Available Seat Count', COUNT(*) FROM reservation.scheduled_seat WHERE is_reserved = 0;

SELECT '=== ğŸ“… 2025ë…„ 7ì›” ì˜ˆì•½ ê°€ëŠ¥ ë…¸ì„  (ìƒìœ„ 20ê°œ) ===' as result;

SELECT 
    DATE_FORMAT(r.schedule_date, '%mì›” %dì¼') as 'ë‚ ì§œ',
    CASE DAYOFWEEK(r.schedule_date)
        WHEN 1 THEN 'ì¼' WHEN 2 THEN 'ì›”' WHEN 3 THEN 'í™”' WHEN 4 THEN 'ìˆ˜'
        WHEN 5 THEN 'ëª©' WHEN 6 THEN 'ê¸ˆ' WHEN 7 THEN 'í† '
    END as 'ìš”ì¼',
    r.departure as 'ì¶œë°œì§€',
    r.arrival as 'ë„ì°©ì§€',
    GROUP_CONCAT(DISTINCT rts.time_slot ORDER BY rts.time_slot) as 'ìš´í–‰ì‹œê°„',
    COUNT(DISTINCT r.route_id) as 'ìš´í–‰í¸ìˆ˜'
FROM reservation.route r
JOIN reservation.route_time_slot rts ON r.route_id = rts.route_id
WHERE r.schedule_date >= '2025-07-01' AND r.schedule_date < '2025-08-01'
GROUP BY r.schedule_date, r.departure, r.arrival
ORDER BY r.schedule_date, r.departure, r.arrival
LIMIT 20;

SELECT '=== ğŸ’° ë²„ìŠ¤ ë“±ê¸‰ë³„ ìš”ê¸ˆ ì •ë³´ ===' as result;

SELECT 
    b.bus_name as 'ë²„ìŠ¤ë“±ê¸‰',
    COUNT(DISTINCT b.bus_id) as 'ë³´ìœ ëŒ€ìˆ˜',
    AVG(b.capacity) as 'í‰ê· ì¢Œì„ìˆ˜',
    MIN(CAST(ss.seat_price AS DECIMAL)) as 'ìµœì €ìš”ê¸ˆ',
    MAX(CAST(ss.seat_price AS DECIMAL)) as 'ìµœê³ ìš”ê¸ˆ',
    ROUND(AVG(CAST(ss.seat_price AS DECIMAL)), 0) as 'í‰ê· ìš”ê¸ˆ'
FROM reservation.bus b
LEFT JOIN reservation.route_schedule rs ON b.bus_id = rs.bus
LEFT JOIN reservation.scheduled_seat ss ON rs.route_schedule_id = ss.route_schedule_route_schedule_id
GROUP BY b.bus_name
ORDER BY í‰ê· ìš”ê¸ˆ DESC;

SELECT '=== ğŸ¯ ë…¸ì„  í†µê³„ (ê¶Œì—­ë³„) ===' as result;

{%- if region_stats %}
SELECT region_from, region_to, route_count, avg_time_slots
FROM (
{%- for stat in region_stats %}
    SELECT '{{ stat.region_from }}' as region_from, '{{ stat.region_to }}' as region_to, 
           {{ stat.route_count }} as route_count, {{ stat.avg_time_slots }} as avg_time_slots
    {%- if not loop.last %} UNION ALL{% endif %}
{%- endfor %}
) stats
ORDER BY route_count DESC
LIMIT 15;
{%- endif %}